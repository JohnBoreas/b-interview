##### Redis怎么保持缓存与数据库一致性？

答：更新数据，先更新数据库，再更新缓存

为何？只要是抓到的就认为是最新的，多线程并发下，如果存在同时两个线程更新一条记录时，我们也没法判断哪条最新，只要保证db与缓存一致即可，配置了多个抓取间隔逻辑，数据可以等下次更新，不因为某次数据抖动，而影响抓取效率问题，达成最终一致性。

为何先更新数据库？redis主要是为了防止同一条数据多次更新，减轻db压力，先删除缓存也会导致db与缓存不一致情况

先更新数据再更新缓存也可能导致数据库不一致的情况，只是概率很小很小，再者我们还通过，所有数据都会写到一个队列里先，写db只用一个线程去更新的方式保证，抓总比写db慢

表会记录一个订单状态的历史记录

话外：当然也可能会有其他各种问题导致的不一致的情况，但是生产中基本没怎么发生过



#### 一、不一致分为三种情况：

1. 数据库有数据，缓存没有数据；

2. 数据库有数据，缓存也有数据，数据不相等；

3. 数据库没有数据，缓存有数据。



#### 二、缓存的使用策略

**1. 首先尝试从缓存读取，读到数据则直接返回；如果读不到，就读数据库，并将数据会写到缓存，并返回。**

**2. 需要更新数据时，先更新数据库，然后把缓存里对应的数据失效掉（删掉）。**





#### 三、先删（更新）缓存再更新db有何影响

导致db与缓存不一致

多个线程同时更新，AB线程删除缓存后，更新数据库前，C读不到缓存读数据库，这时A完成更新，C读到A更新后的值，并更新db与缓存，B再更新数据库，导致缓存与db不一致

AB线程更新数据，A先更新缓存，B更新缓存更新数据库，A再更新数据库

解决方案大概有以下几种：

**1. 对删除缓存进行重试，数据的一致性要求越高，我越是重试得快。**

**2. 定期全量更新，简单地说，就是我定期把缓存全部清掉，然后再全量加载。**

**3. 给所有的缓存一个失效期。**



#### 四、更新数据库成功，但缓存更新失败

更新重试，定期全量更新，缓存设置有效期

**1. 对缓存更新进行重试，数据的一致性要求越高，我越是重试得快。**

**2. 定期全量更新，简单地说，就是我定期把缓存全部清掉，然后再全量加载。**

**3. 给所有的缓存一个失效期。**





**并发不高的情况：**

读: 读redis->没有，读mysql->把mysql数据写回redis，有的话直接从redis中取；

写: 写mysql->成功，再写redis；

**并发高的情况：**

读: 读redis->没有，读mysql->把mysql数据写回redis，有的话直接从redis中取；

写：异步话，先写入redis的缓存，就直接返回；定期或特定动作将数据保存到mysql，可以做到多次更新，一次保存；